services:
  openclaw-meza:
    build: .
    container_name: openclaw-meza
    restart: unless-stopped

    # --- Security hardening ---
    read_only: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

    # --- Resource limits ---
    mem_limit: 2g
    memswap_limit: 2g
    cpus: 1.0
    pids_limit: 256

    # --- Networking ---
    # Host networking so gateway binds to host loopback directly
    # Dashboard at 127.0.0.1:18790 (access via SSH tunnel or Nginx)
    network_mode: host

    # --- Writable tmpfs for temp files (noexec, nosuid) ---
    tmpfs:
      - /tmp:noexec,nosuid,size=64m

    # --- Persistent volumes ---
    volumes:
      # Config (read-only)
      - ./openclaw.json:/home/node/.openclaw/openclaw.json:ro
      # Persistent state (credentials, WhatsApp session, agent state)
      - openclaw-meza-credentials:/home/node/.openclaw/credentials
      - openclaw-meza-state:/home/node/.openclaw/state
      - openclaw-meza-agents:/home/node/.openclaw/agents
      - openclaw-meza-canvas:/home/node/.openclaw/canvas
      - openclaw-meza-cron:/home/node/.openclaw/cron
      - openclaw-meza-devices:/home/node/.openclaw/devices
      - openclaw-meza-identity:/home/node/.openclaw/identity
      - openclaw-meza-workspace:/home/node/.openclaw/workspace

    # --- Environment ---
    env_file:
      - .env

    # --- Command: password auth for dashboard access ---
    command: ["openclaw", "gateway", "--port", "18790", "--auth", "password", "--password", "${OPENCLAW_GATEWAY_TOKEN}"]

    # --- Logging ---
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  openclaw-meza-credentials:
  openclaw-meza-state:
  openclaw-meza-agents:
  openclaw-meza-canvas:
  openclaw-meza-cron:
  openclaw-meza-devices:
  openclaw-meza-identity:
  openclaw-meza-workspace:
